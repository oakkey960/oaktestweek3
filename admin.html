<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="cssadmin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

</head>

<body>
    <!-- ‚úÖ Navbar -->
    <div class="navbar-container">
        <div class="navbar-top"></div>
        <div class="navbar">
            <div class="navbar-left">
                <a href="home.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                    <img src="https://i.postimg.cc/XvS1jwB8/1.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" />
                    <span>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏ô‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡∏≠</span>
                </a>
            </div>
            <div class="hamburger-menu">
                <button class="hamburger-icon" id="hamburgerToggle">‚ò∞</button>
                <div id="hamburgerDropdown" class="hamburger-dropdown">
                    <div class="hamburger-user">üë§ <span id="hamburgerUser">Admin</span></div>
                    <a href="logs.html">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</a>
                    <a href="index.html" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                    <a href="books_admin_view.html" onclick="logout()">üõ† ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</a>
                </div>
            </div>
        </div>
        <div class="navbar-bottom"></div>
    </div>

    <h2>üìò ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</h2>

    <div class="container">
        <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
        <div class="form-section">
            <form id="uploadForm">
                <label for="title">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label>
                <input type="text" id="title" name="title" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
                <!-- main -->
                <label for="mainCategory">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å</label>
                <select id="mainCategory" required>
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å --</option>
                    <option value="‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                    <option value="‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                    <option value="‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏™‡∏ô‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à">‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏™‡∏ô‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à</option>
                    <option value="‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£">‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£</option>
                    <option value="‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option>
                </select>

                <label for="subCategory">‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢</label>
                <select id="subCategory" required>
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ --</option>
                </select>

                <input type="hidden" id="category" name="category" required>

                <label for="pdf">‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label>
                <input type="file" id="pdf" accept="application/pdf" required>
                <!-- end main -->
                <button type="submit">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</button>
            </form>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤: Preview -->
        <div class="preview-section">
            <div id="preview" style="display: none;">
                <h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h3>
                <strong id="previewTitle"></strong><br>
                <span id="previewCategory"></span><br><br>
                <img id="coverPreview" src="" alt="‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">
                <br>
                <iframe id="pdfViewer" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-top">
            <span>¬© 2025 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏ô‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡∏≠</span>
        </div>
        <div class="footer-bottom">
            <span>‡∏´‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ : ‡∏ô.‡∏≠.‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÄ‡∏ï‡∏ä‡∏∞‡∏û‡∏á‡∏®‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡πÇ‡∏ó‡∏£. 089-893-8805</span>
        </div>
    </footer>

    <!-- ‚úÖ Supabase ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabase = createClient(
            "https://nceyapolnyhwzgssfson.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZXlhcG9sbnlod3pnc3Nmc29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5MjAwMjUsImV4cCI6MjA2NTQ5NjAyNX0.pCB24tf7CoLoHBGm4opDFk-n43Kc1n16PRgiMYHh8fo"
        );

        const subCategories = {
            "‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£": ["‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê"],
            "‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": [
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
                "‡∏´‡∏•‡∏±‡∏Å‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢",
                "‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢"
            ],
            "‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏™‡∏ô‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à": ["‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢", "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏ô‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£/‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£"],
            "‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£": ["‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£"],
            "‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°": ["‡∏™‡∏±‡∏á‡∏Ñ‡∏°", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©", "‡∏î‡∏π‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®"]
        };

        const mainSelect = document.getElementById("mainCategory");
        const subSelect = document.getElementById("subCategory");
        const categoryInput = document.getElementById("category");

        mainSelect.addEventListener("change", function () {
            const main = this.value;
            subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ --</option>';
            if (subCategories[main]) {
                subCategories[main].forEach(sub => {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.textContent = sub;
                    subSelect.appendChild(opt);
                });
            }
            updateCategoryValue();
        });

        subSelect.addEventListener("change", updateCategoryValue);

        function updateCategoryValue() {
            const main = mainSelect.value;
            const sub = subSelect.value;
            categoryInput.value = main && sub ? `${main} > ${sub}` : "";
            document.getElementById("previewCategory").textContent =
                categoryInput.value ? `‡∏´‡∏°‡∏ß‡∏î: ${categoryInput.value}` : "";
        }

        document.getElementById("pdf").addEventListener("change", async function () {
            const file = this.files[0];
            if (!file) return;

            document.getElementById("title").addEventListener("input", function () {
                document.getElementById("previewTitle").textContent = this.value;
            });

            const fileName = file.name.replace(/\.[^/.]+$/, "");
            const titleInput = document.getElementById("title");
            titleInput.value = fileName;
            document.getElementById("previewTitle").textContent = fileName;

            const fileURL = URL.createObjectURL(file);
            document.getElementById("pdfViewer").src = fileURL + "#toolbar=0";

            const pdf = await pdfjsLib.getDocument(fileURL).promise;
            const page = await pdf.getPage(1);

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            const viewport = page.getViewport({ scale: 1.5 });

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: context, viewport }).promise;

            canvas.toBlob(blob => {
                const imageUrl = URL.createObjectURL(blob);
                document.getElementById("coverPreview").src = imageUrl;
            });

            document.getElementById("preview").style.display = "block";
        });

        document.getElementById("uploadForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const title = document.getElementById("title").value;
            const mainCategory = document.getElementById("mainCategory").value;
            const subCategory = document.getElementById("subCategory").value;
            const pdfFile = document.getElementById("pdf").files[0];

            if (!title || !mainCategory || !subCategory || !pdfFile) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                return;
            }

            try {
                const filename = `${Date.now()}_${pdfFile.name}`;

                // üî∫ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from("books")
                    .upload(`pdfs/${filename}`, pdfFile, { upsert: true });

                if (uploadError) throw uploadError;

                // üî∫ ‡∏™‡∏£‡πâ‡∏≤‡∏á public URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå
                const { data: publicUrlData } = supabase.storage
                    .from("books")
                    .getPublicUrl(`pdfs/${filename}`);

                const pdf_url = publicUrlData.publicUrl;

                // üî∫ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á books
                const { error: insertError } = await supabase.from("books").insert([
                    {
                        title,
                        category_main: mainCategory,
                        category_sub: subCategory,
                        pdf_url: pdf_url
                    }
                ]);

                if (insertError) throw insertError;

                alert("üìö ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                this.reset();
                document.getElementById("preview").style.display = "none";

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }

        });
        document.getElementById("hamburgerToggle").addEventListener("click", function (e) {
            e.stopPropagation();
            document.getElementById("hamburgerDropdown").classList.toggle("show");
        });

        // ‡∏õ‡∏¥‡∏î dropdown ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
        document.addEventListener("click", function () {
            document.getElementById("hamburgerDropdown").classList.remove("show");
        });
    </script>
</body>

</html>