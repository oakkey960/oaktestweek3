<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╣Гр╕лр╕бр╣И</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="cssadmin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

</head>

<body>
    <!-- тЬЕ Navbar -->
    <div class="navbar-container">
        <div class="navbar-top"></div>
        <div class="navbar">
            <div class="navbar-left">
                <a href="home.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                    <img src="https://i.postimg.cc/XvS1jwB8/1.png" alt="р╣Вр╕ер╣Вр╕Бр╣Й" />
                    <span>р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Чр╕лр╕▓р╕гр╣Ар╕гр╕╖р╕н</span>
                </a>
            </div>
            <div class="hamburger-menu">
                <button class="hamburger-icon" id="hamburgerToggle">тШ░</button>
                <div id="hamburgerDropdown" class="hamburger-dropdown">
                    <div class="hamburger-user">ЁЯСд <span id="hamburgerUser">Admin</span></div>
                    <a href="logs.html">ЁЯУЪ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щ</a>
                    <a href="index.html" onclick="logout()">ЁЯЪк р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ</a>
                    <a href="books_admin_view.html" onclick="logout()">ЁЯЫа р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</a>
                </div>
            </div>
        </div>
        <div class="navbar-bottom"></div>
    </div>

    <h2>ЁЯУШ р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╣Гр╕лр╕бр╣И</h2>

    <div class="container">
        <!-- р╕Лр╣Йр╕▓р╕в: р╕Яр╕нр╕гр╣Мр╕б -->
        <div class="form-section">
            <form id="uploadForm">
                <label for="title">р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</label>
                <input type="text" id="title" name="title" required placeholder="р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕Ир╕░р╕Цр╕╣р╕Бр╣Ар╕Хр╕┤р╕бр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤">
                <!-- main -->
                <label for="mainCategory">р╕лр╕бр╕зр╕Фр╕лр╕ер╕▒р╕Б</label>
                <select id="mainCategory" required>
                    <option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕зр╕Фр╕лр╕ер╕▒р╕Б --</option>
                    <option value="р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ьр╕╣р╣Йр╕Щр╕│р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕г">р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ьр╕╣р╣Йр╕Щр╕│р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕г</option>
                    <option value="р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╕Др╕Зр╣Бр╕ер╕░р╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣М">р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╕Др╕Зр╣Бр╕ер╕░р╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣М</option>
                    <option value="р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Бр╕┤р╕И">р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Бр╕┤р╕И</option>
                    <option value="р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г">р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г</option>
                    <option value="р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕кр╕▒р╕Зр╕Др╕б">р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕кр╕▒р╕Зр╕Др╕б</option>
                </select>

                <label for="subCategory">р╕лр╕бр╕зр╕Фр╕вр╣Ир╕нр╕в</label>
                <select id="subCategory" required>
                    <option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕зр╕Фр╕вр╣Ир╕нр╕в --</option>
                </select>

                <input type="hidden" id="category" name="category" required>

                <label for="pdf">р╣Др╕Яр╕ер╣М PDF р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</label>
                <input type="file" id="pdf" accept="application/pdf" required>
                <!-- end main -->
                <button type="submit">ЁЯУд р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</button>
            </form>
        </div>

        <!-- р╕Вр╕зр╕▓: Preview -->
        <div class="preview-section">
            <div id="preview" style="display: none;">
                <h3>р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</h3>
                <strong id="previewTitle"></strong><br>
                <span id="previewCategory"></span><br><br>
                <img id="coverPreview" src="" alt="р╕Ыр╕Бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н">
                <br>
                <iframe id="pdfViewer" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-top">
            <span>┬й 2025 р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Чр╕лр╕▓р╕гр╣Ар╕гр╕╖р╕н</span>
        </div>
        <div class="footer-bottom">
            <span>р╕лр╕▓р╕Бр╕Ыр╕гр╕░р╕кр╕Ър╕Ыр╕▒р╕Нр╕лр╕▓р╣Вр╕Ыр╕гр╕Фр╕Хр╕┤р╕Фр╕Хр╣Ир╕н : р╕Щ.р╕н.р╕ир╕▒р╕Бр╕Фр╕┤р╣Мр╕кр╕┤р╕Чр╕Шр╕┤р╣М р╣Ар╕Хр╕Кр╕░р╕Юр╕Зр╕ир╣Мр╕Ыр╕гр╕░р╣Ар╕кр╕гр╕┤р╕Р р╣Вр╕Чр╕г. 089-893-8805</span>
        </div>
    </footer>

    <!-- тЬЕ Supabase р╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabase = createClient(
            "https://nceyapolnyhwzgssfson.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZXlhcG9sbnlod3pnc3Nmc29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5MjAwMjUsImV4cCI6MjA2NTQ5NjAyNX0.pCB24tf7CoLoHBGm4opDFk-n43Kc1n16PRgiMYHh8fo"
        );

        const subCategories = {
            "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ьр╕╣р╣Йр╕Щр╕│р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕г": ["р╕Ьр╕╣р╣Йр╕Щр╕│р╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г", "р╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕гр╕нр╕Зр╕Др╣Мр╕Бр╕гр╕ар╕▓р╕Др╕гр╕▒р╕Р"],
            "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╕Др╕Зр╣Бр╕ер╕░р╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣М": [
                "р╕Др╕зр╕▓р╕бр╕кр╕▒р╕бр╕Юр╕▒р╕Щр╕Шр╣Мр╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕Ыр╕гр╕░р╣Ар╕Чр╕ир╣Бр╕ер╕░р╣Ар╕ир╕гр╕йр╕Рр╕Бр╕┤р╕Ир╕Бр╕▓р╕гр╣Ар╕бр╕╖р╕нр╕З",
                "р╕лр╕ер╕▒р╕Бр╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣Мр╣Бр╕ер╕░р╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╕Др╕Зр╕Чр╕▓р╕Зр╕Чр╕░р╣Ар╕ер╕Вр╕нр╕Зр╣Др╕Чр╕в",
                "р╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣Мр╣Бр╕ер╕░р╕Щр╣Вр╕вр╕Ър╕▓р╕в"
            ],
            "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Бр╕┤р╕И": ["р╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Ър╣Ар╕гр╕╡р╕вр╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕гр╕вр╕▓р╕в", "р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╣Бр╕ер╕░р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Эр╣Ир╕▓р╕вр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕г/р╕нр╕│р╕Щр╕зр╕вр╕Бр╕▓р╕г"],
            "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г": ["р╕Бр╕▓р╕гр╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г", "р╕Бр╕Ор╕лр╕бр╕▓р╕вр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г"],
            "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕кр╕▒р╕Зр╕Др╕б": ["р╕кр╕▒р╕Зр╕Др╕б", "р╕Бр╕┤р╕Ир╕Бр╕гр╕гр╕бр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕гр╕вр╕▓р╕вр╕Юр╕┤р╣Ар╕ир╕й", "р╕Фр╕╣р╕Бр╕┤р╕Ир╕Бр╕▓р╕гр╣Бр╕ер╕░р╕ир╕╢р╕Бр╕йр╕▓р╕ар╕╣р╕бр╕┤р╕Ыр╕гр╕░р╣Ар╕Чр╕и"]
        };

        const mainSelect = document.getElementById("mainCategory");
        const subSelect = document.getElementById("subCategory");
        const categoryInput = document.getElementById("category");

        mainSelect.addEventListener("change", function () {
            const main = this.value;
            subSelect.innerHTML = '<option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕зр╕Фр╕вр╣Ир╕нр╕в --</option>';
            if (subCategories[main]) {
                subCategories[main].forEach(sub => {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.textContent = sub;
                    subSelect.appendChild(opt);
                });
            }
            updateCategoryValue();
        });

        subSelect.addEventListener("change", updateCategoryValue);

        function updateCategoryValue() {
            const main = mainSelect.value;
            const sub = subSelect.value;
            categoryInput.value = main && sub ? `${main} > ${sub}` : "";
            document.getElementById("previewCategory").textContent =
                categoryInput.value ? `р╕лр╕бр╕зр╕Ф: ${categoryInput.value}` : "";
        }

        document.getElementById("pdf").addEventListener("change", async function () {
            const file = this.files[0];
            if (!file) return;

            document.getElementById("title").addEventListener("input", function () {
                document.getElementById("previewTitle").textContent = this.value;
            });

            const fileName = file.name.replace(/\.[^/.]+$/, "");
            const titleInput = document.getElementById("title");
            titleInput.value = fileName;
            document.getElementById("previewTitle").textContent = fileName;

            const fileURL = URL.createObjectURL(file);
            document.getElementById("pdfViewer").src = fileURL + "#toolbar=0";

            const pdf = await pdfjsLib.getDocument(fileURL).promise;
            const page = await pdf.getPage(1);

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            const viewport = page.getViewport({ scale: 1.5 });

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: context, viewport }).promise;

            canvas.toBlob(blob => {
                const imageUrl = URL.createObjectURL(blob);
                document.getElementById("coverPreview").src = imageUrl;
            });

            document.getElementById("preview").style.display = "block";
        });

        document.getElementById("uploadForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const title = document.getElementById("title").value;
            const mainCategory = document.getElementById("mainCategory").value;
            const subCategory = document.getElementById("subCategory").value;
            const pdfFile = document.getElementById("pdf").files[0];

            if (!title || !mainCategory || !subCategory || !pdfFile) {
                alert("р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╣Йр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ");
                return;
            }

            try {
                const filename = `${Date.now()}_${pdfFile.name}`;

                // ЁЯФ║ р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф PDF р╣Др╕Ыр╕вр╕▒р╕З Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from("books")
                    .upload(`pdfs/${filename}`, pdfFile, { upsert: true });

                if (uploadError) throw uploadError;

                // ЁЯФ║ р╕кр╕гр╣Йр╕▓р╕З public URL р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Др╕Яр╕ер╣М
                const { data: publicUrlData } = supabase.storage
                    .from("books")
                    .getPublicUrl(`pdfs/${filename}`);

                const pdf_url = publicUrlData.publicUrl;

                // ЁЯФ║ р╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З books
                const { error: insertError } = await supabase.from("books").insert([
                    {
                        title,
                        category_main: mainCategory,
                        category_sub: subCategory,
                        pdf_url: pdf_url
                    }
                ]);

                if (insertError) throw insertError;

                alert("ЁЯУЪ р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Бр╕ер╕░р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╣Ар╕гр╣Зр╕И!");
                this.reset();
                document.getElementById("preview").style.display = "none";

            } catch (err) {
                console.error(err);
                alert("тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: " + err.message);
            }

        });
        document.getElementById("hamburgerToggle").addEventListener("click", function (e) {
            e.stopPropagation();
            document.getElementById("hamburgerDropdown").classList.toggle("show");
        });

        // р╕Ыр╕┤р╕Ф dropdown р╕Цр╣Йр╕▓р╕Др╕ер╕┤р╕Бр╕Вр╣Йр╕▓р╕Зр╕Щр╕нр╕Б
        document.addEventListener("click", function () {
            document.getElementById("hamburgerDropdown").classList.remove("show");
        });
    </script>
</body>

</html>