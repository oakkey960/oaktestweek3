<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>р╕лр╕Щр╣Йр╕▓р╣Бр╕гр╕Б</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <link href="csshome.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>

<body>
  <!-- тЬЕ Navbar -->
  <div class="navbar-container">
    <div class="navbar-top"></div>
    <div class="navbar">
      <div class="navbar-left">
        <a href="home.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
          <img src="https://i.postimg.cc/XvS1jwB8/1.png" alt="р╣Вр╕ер╣Вр╕Бр╣Й" />
          <span>р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Чр╕лр╕▓р╕гр╣Ар╕гр╕╖р╕н</span>
        </a>
      </div>
      <div class="hamburger-menu">
        <button class="hamburger-icon" id="hamburgerToggle">тШ░</button>
        <div id="hamburgerDropdown" class="hamburger-dropdown">
          <div class="hamburger-user">ЁЯСд <span id="hamburgerUser">р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й</span></div>
          <a href="logs.html">ЁЯУЪ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щ</a>
          <a href="index.html" onclick="logout()">ЁЯЪк р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ</a>
        </div>
      </div>
    </div>
    <div class="navbar-bottom"></div>
  </div>

  <!-- тЬЕ Header -->
  <main>
    <div class="login-header">
      <span>р╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Фр╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Чр╕лр╕▓р╕гр╣Ар╕гр╕╖р╕н</span>
    </div>

    <!-- тЬЕ Filter Controls -->
    <div class="nav-controls">
      <div class="dropdown">
        <div class="dropdown-toggle" id="dropdownToggle">р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕зр╕Фр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н тЦ╛</div>
        <div class="dropdown-list" id="dropdownMenu"></div>
      </div>
      <input type="text" id="searchInput" class="custom-input" placeholder="р╕Др╣Йр╕Щр╕лр╕▓р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н...">
    </div>

    <!-- тЬЕ Book Section -->
    <h2>ЁЯУШ р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф</h2>
    <div id="bookContainer" class="book-grid"></div>
  </main>

  <footer>
    <div class="footer-top">
      <span>┬й 2025 р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Чр╕лр╕▓р╕гр╣Ар╕гр╕╖р╕н</span>
    </div>
    <div class="footer-bottom">
      <span>р╕лр╕▓р╕Бр╕Ыр╕гр╕░р╕кр╕Ър╕Ыр╕▒р╕Нр╕лр╕▓р╣Вр╕Ыр╕гр╕Фр╕Хр╕┤р╕Фр╕Хр╣Ир╕н : р╕Щ.р╕н.р╕ир╕▒р╕Бр╕Фр╕┤р╣Мр╕кр╕┤р╕Чр╕Шр╕┤р╣М р╣Ар╕Хр╕Кр╕░р╕Юр╕Зр╕ир╣Мр╕Ыр╕гр╕░р╣Ар╕кр╕гр╕┤р╕Р р╣Вр╕Чр╕г. 089-893-8805</span>
    </div>
  </footer>

  <!-- тЬЕ JS Section -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const SUPABASE_URL = 'https://hsraobyushrnafntzksg.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzcmFvYnl1c2hybmFmbnR6a3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDQ5ODgsImV4cCI6MjA2NjMyMDk4OH0.2YTiXCStLyFdkuUNcNa2FP7ygyg70LWrypceSHlGERw';
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const subjects = {
        "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ьр╕╣р╣Йр╕Щр╕│р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕г": ["- р╕Ьр╕╣р╣Йр╕Щр╕│р╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г", "- р╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕гр╕нр╕Зр╕Др╣Мр╕Бр╕гр╕ар╕▓р╕Др╕гр╕▒р╕Р"],
        "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╕Др╕Зр╣Бр╕ер╕░р╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣М": ["- р╕Др╕зр╕▓р╕бр╕кр╕▒р╕бр╕Юр╕▒р╕Щр╕Шр╣Мр╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕Ыр╕гр╕░р╣Ар╕Чр╕ир╣Бр╕ер╕░р╣Ар╕ир╕гр╕йр╕Рр╕Бр╕┤р╕Ир╕Бр╕▓р╕гр╣Ар╕бр╕╖р╕нр╕З", "- р╕лр╕ер╕▒р╕Бр╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣Мр╣Бр╕ер╕░р╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╕Др╕Зр╕Чр╕▓р╕Зр╕Чр╕░р╣Ар╕ер╕Вр╕нр╕Зр╣Др╕Чр╕в", "- р╕вр╕╕р╕Чр╕Шр╕ир╕▓р╕кр╕Хр╕гр╣Мр╣Бр╕ер╕░р╕Щр╣Вр╕вр╕Ър╕▓р╕в"],
        "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕гр╕Бр╕┤р╕И": ["- р╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Ър╣Ар╕гр╕╡р╕вр╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕гр╕вр╕▓р╕в", "- р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╣Бр╕ер╕░р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Эр╣Ир╕▓р╕вр╣Ар╕кр╕Щр╕▓р╕Шр╕┤р╕Бр╕▓р╕г/р╕нр╕│р╕Щр╕зр╕вр╕Бр╕▓р╕г"],
        "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г": ["- р╕Бр╕▓р╕гр╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г", "- р╕Бр╕Ор╕лр╕бр╕▓р╕вр╕Чр╕▓р╕Зр╕Чр╕лр╕▓р╕г"],
        "р╕лр╕бр╕зр╕Фр╕зр╕┤р╕Кр╕▓р╕кр╕▒р╕Зр╕Др╕б": ["- р╕кр╕▒р╕Зр╕Др╕б", "- р╕Бр╕┤р╕Ир╕Бр╕гр╕гр╕бр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕гр╕гр╕вр╕▓р╕вр╕Юр╕┤р╣Ар╕ир╕й", "- р╕Фр╕╣р╕Бр╕┤р╕Ир╕Бр╕▓р╕гр╣Бр╕ер╕░р╕ир╕╢р╕Бр╕йр╕▓р╕ар╕╣р╕бр╕┤р╕Ыр╕гр╕░р╣Ар╕Чр╕и"]
      };

      let currentCategory = "р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф";

      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (currentUser) {
        document.getElementById('hamburgerUser').textContent = currentUser.fullname || currentUser.username;
        if (currentUser.username === 'admin') {
          const adminLink = document.createElement('a');
          adminLink.href = 'books_admin_view.html';
          adminLink.textContent = 'ЁЯЫа р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н';
          document.getElementById('hamburgerDropdown').appendChild(adminLink);
        }
      }

      document.getElementById('searchInput').addEventListener('input', () => {
        const query = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.book-card').forEach(card => {
          const text = card.innerText.toLowerCase();
          card.style.display = text.includes(query) ? 'flex' : 'none';
        });
      });

      // тЬЕ Hamburger toggle
      document.getElementById('hamburgerToggle').addEventListener('click', function (e) {
        e.stopPropagation();
        document.getElementById("hamburgerDropdown").classList.toggle("show");
      });

      // тЬЕ Dropdown toggle
      document.getElementById('dropdownToggle').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById("dropdownMenu").classList.toggle("show");
      });

      // тЬЕ Close menus when click outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById("hamburgerDropdown");
        const toggle = document.getElementById("hamburgerToggle");
        if (!dropdown.contains(e.target) && e.target !== toggle) {
          dropdown.classList.remove("show");
        }

        const menu = document.getElementById("dropdownMenu");
        if (!menu.contains(e.target) && e.target.id !== "dropdownToggle") {
          menu.classList.remove("show");
          document.querySelectorAll(".submenu").forEach(m => m.style.display = "none");
        }
      });

      // тЬЕ Logout
      window.logout = () => localStorage.removeItem('currentUser');

      // тЬЕ Create dropdown filter menu
      function createDropdownMenu(subjects) {
        const container = document.getElementById("dropdownMenu");
        container.innerHTML = "";

        const allItem = document.createElement("div");
        allItem.className = "dropdown-item";
        allItem.textContent = "р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф";
        allItem.onclick = () => {
          currentCategory = "р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф";
          filterBooks(currentCategory);
        };
        container.appendChild(allItem);

        for (const category in subjects) {
          const wrapper = document.createElement("div");
          wrapper.className = "dropdown-category";

          const titleDiv = document.createElement("div");
          titleDiv.className = "dropdown-item";
          titleDiv.textContent = category;

          const submenu = document.createElement("div");
          submenu.className = "submenu";

          subjects[category].forEach(sub => {
            const subItem = document.createElement("div");
            subItem.className = "submenu-item";
            subItem.textContent = sub;
            subItem.onclick = (e) => {
              e.stopPropagation();
              currentCategory = sub;
              filterBooks(currentCategory);
            };
            submenu.appendChild(subItem);
          });

          titleDiv.onclick = (e) => {
            e.stopPropagation();
            const isVisible = submenu.style.display === 'flex';
            document.querySelectorAll(".submenu").forEach(menu => {
              if (menu !== submenu) menu.style.display = 'none';
            });

            submenu.style.display = isVisible ? 'none' : 'flex';
            currentCategory = category;
            filterBooks(currentCategory);
          };

          wrapper.appendChild(titleDiv);
          wrapper.appendChild(submenu);
          container.appendChild(wrapper);
        }
      }

      // тЬЕ Filter books by category & search
      function filterBooks(category) {
        const input = document.getElementById("searchInput").value.toLowerCase().trim();
        const cards = document.querySelectorAll(".book-card");

        const heading = document.querySelector("main h2");
        heading.textContent = `ЁЯУШ ${category}`;

        cards.forEach(card => {
          const title = card.querySelector("h3").innerText.toLowerCase();
          const p = card.querySelector("p");
          const main = p.getAttribute("data-main")?.toLowerCase() || "";
          const sub = p.getAttribute("data-sub")?.toLowerCase() || "";

          const matchesText = title.includes(input) || main.includes(input) || sub.includes(input);

          let matchesCategory = false;

          if (category === "р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") {
            matchesCategory = true;
          } else if (subjects.hasOwnProperty(category)) {
            // р╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╕лр╕бр╕зр╕Фр╕лр╕ер╕▒р╕Б: р╣Ар╕Кр╣Зр╕Д sub category
            const subs = subjects[category].map(s => s.replace(/^- /, "").toLowerCase());
            matchesCategory = subs.includes(sub);
          } else {
            // р╣Ар╕Ыр╣Зр╕Щр╕лр╕бр╕зр╕Фр╕вр╣Ир╕нр╕в
            matchesCategory = sub === category.toLowerCase().replace(/^- /, "");
          }

          card.style.display = matchesText && matchesCategory ? "flex" : "none";
        });
      }



      // тЬЕ Load books from Supabase and render
      async function loadBooks() {
        const { data: books, error } = await client.from("books").select("*");
        if (error) {
          console.error("р╣Вр╕лр╕ер╕Фр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:", error);
          return;
        }

        const container = document.getElementById("bookContainer");
        for (const book of books) {
          // р╣Вр╕лр╕ер╕Ф PDF р╕Ыр╕Б
          const pdfBlob = await fetch(book.pdf_url).then(res => res.blob());
          const pdfURL = URL.createObjectURL(pdfBlob);
          const pdf = await pdfjsLib.getDocument(pdfURL).promise;
          const page = await pdf.getPage(1);
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          const viewport = page.getViewport({ scale: 1.5 });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          await page.render({ canvasContext: context, viewport }).promise;

          const coverImage = canvas.toDataURL();

          // тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╕Бр╕▓р╕гр╣Мр╕Ф
          const card = document.createElement("div");
          card.className = "book-card";
          card.innerHTML = `
  <img src="${coverImage}" alt="р╕Ыр╕Бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н ${book.title}" />
  <h3>${book.title}</h3>
  <p data-main="${book.category_main}" data-sub="${book.category_sub}">
    ${book.category_main} ${book.category_sub}
  </p>
  <button class="read-button">ЁЯУЦ р╕нр╣Ир╕▓р╕Щр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</button>
`;


          // тЬЕ р╕Ьр╕╣р╕Бр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕З DOM load р╣Бр╕ер╣Йр╕з
          const readButton = card.querySelector(".read-button");
          readButton.addEventListener("click", async () => {
            const fullPath = book.pdf_url; // р╕кр╣Ир╕Зр╕Чр╕▒р╣Йр╕З URL р╣Др╕Ыр╣Ар╕ер╕в
            window.open(`reader.html?file=${encodeURIComponent(fullPath)}`, '_blank');
            if (fullPath) {
              // тЬЕ р╕Бр╣Ир╕нр╕Щр╣Ар╕Ыр╕┤р╕Ф reader.html р╣Гр╕лр╣Йр╣Ар╕Бр╣Зр╕Ъ log р╕ер╕З book_reads
              const currentUser = JSON.parse(localStorage.getItem('currentUser'));
              if (currentUser && currentUser.id) {
                const { error: readLogError } = await client.from('book_reads').insert([{
                  user_id: currentUser.id,           // ЁЯЯв р╣Гр╕Кр╣Й ID р╕Ир╕гр╕┤р╕Зр╕Ир╕▓р╕Б profiles
                  book_title: book.title,
                  read_at: new Date().toISOString()
                }]);
                if (readLogError) {
                  console.error("тЭМ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:", readLogError);
                }
              }

              // тЬЕ р╣Ар╕Ыр╕┤р╕Ф reader
              window.open(`reader.html?file=${encodeURIComponent(fullPath)}`, '_blank');
            } else {
              alert("р╣Др╕бр╣Ир╕Юр╕Ър╣Др╕Яр╕ер╣М PDF");
            }
          });

          container.appendChild(card);
        }
      }
      createDropdownMenu(subjects);
      loadBooks();
    });
  </script>
</body>

</html>