<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <link href="csshome.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body>
  <!-- üçî Navbar -->
  <nav class="navbar">
    <span class="logo">üìö ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î</span>
    <div class="menu" id="hamburgerMenu">
      <a href="home.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="logs.html">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
      <!-- ‡∏•‡∏¥‡∏á‡∏Å‡πå admin ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS ‡∏ñ‡πâ‡∏≤ user ‡πÄ‡∏õ‡πá‡∏ô admin -->
    </div>
  </nav>

  <main>
    <h2>üìò ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="bookContainer" class="book-grid"></div>
  </main>

  <script>
    const supabaseUrl = "https://nceyapolnyhwzgssfson.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    const adminId = "admin-user-id"; // üõ† ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ID ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á admin

    async function loadUserAndBooks() {
      const { data: { user } } = await supabase.auth.getUser();

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ admin
      if (user && user.id === adminId) {
        const adminLink = document.createElement("a");
        adminLink.href = "admin.html";
        adminLink.textContent = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠";
        document.getElementById("hamburgerMenu").appendChild(adminLink);
      }

      // ‚úÖ ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const { data: books, error } = await supabase.from("books").select("*");
      if (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", error);
        return;
      }

      const container = document.getElementById("bookContainer");

      for (const book of books) {
        const pdfBlob = await fetch(book.pdf_url).then(res => res.blob());
        const pdfURL = URL.createObjectURL(pdfBlob);

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        const pdf = await pdfjsLib.getDocument(pdfURL).promise;
        const page = await pdf.getPage(1);
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: context, viewport }).promise;
        const coverImage = canvas.toDataURL();

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á book card
        const card = document.createElement("div");
        card.className = "book-card";
        card.innerHTML = `
          <img src="${coverImage}" alt="‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" />
          <h3>${book.title}</h3>
          <p>${book.category_main} > ${book.category_sub}</p>
          <a href="${book.pdf_url}" target="_blank">üìñ ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</a>
        `;
        container.appendChild(card);
      }
    }

    loadUserAndBooks();
  </script>
</body>

</html>